---
title: "regressions"
author: "Ryan Zhang"
date: "10/28/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(Hmisc)
library(rqPen)
library(vctrs)
library(foreign)
library(margins)
library(mfx)
library(VGAM)
library(erer)
library(nnet)
library(RStata)
library(mlogit)
library(jtools)
library(ggstance)
library(clogitboost)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(ggplot2)

```


# Read Data

```{r}

df08phone_d <- read.dta("clean_data/df08phone_d.dta")
df08phone_r <- read.dta("clean_data/df08phone_r.dta")

df04_national_d <- read.dta("clean_data/df04_national_d.dta")
df00_national_d <- read.dta("clean_data/df00_national_d.dta")
df00_national_r <- read.dta("clean_data/df00_national_r.dta")
df84cm_d <- read.dta("clean_data/df84cm_d.dta")

df00_super_d <- read.dta("clean_data/df00_super_d.dta")
df00_super_r <- read.dta("clean_data/df00_super_r.dta")
df88st_d <- read.dta("clean_data/df88st_d.dta")
df88st_r <- read.dta("clean_data/df88st_r.dta")

df04_nh_d <- read.dta("clean_data/df04_nh_d.dta")
df00_nh_d <- read.dta("clean_data/df00_nh_d.dta")
df00_nh_r <- read.dta("clean_data/df00_nh_r.dta")

df00_ia_d <- read.dta("clean_data/df00_ia_d.dta")
df00_ia_r <- read.dta("clean_data/df00_ia_r.dta")

```


## Regressions and Calculations of Odds

```{r}

df08phone_d_reg <- clogit(data = df08phone_d, formula = VoteCandidate ~ CLINTON 
                          + EDWARDS + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                            NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                            strata(ID))
df08phone_r_reg <- clogit(data = df08phone_r, formula = VoteCandidate ~ ROMNEY +
                            HUCKABEE + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                            NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                            strata(ID))
df04_national_d_reg <- clogit(data = df04_national_d, formula = VoteCandidate ~ 
                            EDWARDS + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                            NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                            strata(ID))
df00_national_d_reg <- clogit(data = df00_national_d, formula = VoteCandidate ~ 
                            BRADLEY + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                            NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                            strata(ID))
df00_national_r_reg <- clogit(data = df00_national_r, formula = VoteCandidate ~ 
                            MCCAIN + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                            NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                            strata(ID))
df84cm_d_reg <- clogit(data = df84cm_d, formula = VoteCandidate ~ HART + 
                         JACKSON + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                         NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                         strata(ID))

df00_super_d_reg <- clogit(data = df00_super_d, formula = VoteCandidate ~ 
                             BRADLEY + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                             NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                             strata(ID))
df00_super_r_reg <- clogit(data = df00_super_r, formula = VoteCandidate ~ 
                             MCCAIN + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                             NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                             strata(ID))
df88st_d_reg <- clogit(data = df88st_d, formula = VoteCandidate ~ GEPHARDT + 
                         GORE + HART + JACKSON + NORMALIZED_FT + 
                         NORMALIZED_VIABILITY + NORMALIZED_ELECTABILITY + 
                         NORMALIZED_IDEOLOGY + strata(ID))
df88st_r_reg <- clogit(data = df88st_r, formula = VoteCandidate ~ DOLE + KEMP + 
                     ROBERTSON + NORMALIZED_FT + NORMALIZED_VIABILITY + 
                     NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                     strata(ID))

df04_nh_d_reg <- clogit(data = df04_nh_d, formula = VoteCandidate ~ EDWARDS +
                      NORMALIZED_FT + NORMALIZED_VIABILITY + 
                      NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                      strata(ID))
df00_nh_d_reg <- clogit(data = df00_nh_d, formula = VoteCandidate ~ BRADLEY +  
                      NORMALIZED_FT + NORMALIZED_VIABILITY + 
                      NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                      strata(ID))
df00_nh_r_reg <- clogit(data = df00_nh_r, formula = VoteCandidate ~ MCCAIN +
                      NORMALIZED_FT + NORMALIZED_VIABILITY + 
                      NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                      strata(ID))

df00_ia_d_reg <- clogit(data = df00_ia_d, formula = VoteCandidate ~ BRADLEY + 
                      NORMALIZED_FT + NORMALIZED_VIABILITY + 
                      NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                      strata(ID))
df00_ia_r_reg <- clogit(data = df00_ia_r, formula = VoteCandidate ~ MCCAIN +
                      NORMALIZED_FT + NORMALIZED_VIABILITY + 
                      NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                      strata(ID))

```


```{r}

reg_to_df <- function(x, y) {
  data.frame(variable = rownames(summary(x)$coef),
  coef = summary(x)$coef[, 1],
  se = summary(x)$coef[, 2],
  modelname = deparse(substitute(x)))
}

df08phone_d_reg_df <- reg_to_df(df08phone_d_reg)
df08phone_r_reg_df <- reg_to_df(df08phone_r_reg) 
df04_national_d_reg_df <- reg_to_df(df04_national_d_reg)
df00_national_d_reg_df <- reg_to_df(df00_national_d_reg)
df00_national_r_reg_df <- reg_to_df(df00_national_r_reg)
df84cm_d_reg_df <- reg_to_df(df84cm_d_reg)
df00_super_d_reg_df <- reg_to_df(df00_super_d_reg)
df00_super_r_reg_df <- reg_to_df(df00_super_r_reg)
df88st_d_reg_df <- reg_to_df(df88st_d_reg)
df88st_r_reg_df <- reg_to_df(df88st_r_reg)
df04_nh_d_reg_df <- reg_to_df(df04_nh_d_reg)
df00_nh_d_reg_df <- reg_to_df(df00_nh_d_reg)
df00_nh_r_reg_df <- reg_to_df(df00_nh_r_reg)
df00_ia_d_reg_df <- reg_to_df(df00_ia_d_reg)
df00_ia_r_reg_df <- reg_to_df(df00_ia_r_reg)

allModelFrame <- data.frame(rbind(df08phone_d_reg_df, df08phone_r_reg_df, 
                                  df04_national_d_reg_df, 
                                  df00_national_d_reg_df, 
                                  df00_national_r_reg_df, 
                                  df84cm_d_reg_df, df00_super_d_reg_df, 
                                  df00_super_r_reg_df, df88st_d_reg_df, 
                                  df88st_r_reg_df, df04_nh_d_reg_df, 
                                  df00_nh_d_reg_df, df00_nh_r_reg_df, 
                                  df00_ia_d_reg_df, df00_ia_r_reg_df))

interval1 <- -qnorm((1 - 0.9) / 2)  # 90% CI multiplier
interval2 <- -qnorm((1 - 0.95) / 2)  # 95% CI multiplier

```


```{r}

allModelFrame %>%
  filter(variable == "NORMALIZED_VIABILITY",
         modelname %in% c("df08phone_d_reg", "df04_national_d_reg",
                          "df00_national_d_reg", "df84cm_d_reg")) %>%
  ggplot(aes(color = modelname)) +
    geom_hline(yintercept = 0, colour = gray(1 / 2), lty = 2) +
    geom_pointrange(aes(x = variable, y = coef, 
                        ymin = coef - se * interval2,
                        ymax = coef + se * interval2),
                    lwd = 1 / 2, position = position_dodge(width = 1 / 2),
                    shape = 21, fill = "WHITE") +
    geom_linerange(aes(x = variable, ymin = coef - se*interval1,
                       ymax = coef + se * interval1),
                   lwd = 1, position = position_dodge(width = 1 / 2)) +
    scale_y_continuous(trans = log2_trans(), 
                       breaks = trans_breaks("log2", function(x) 2^x),
                       limits = c(-10, 10)) +
    theme_bw() +
    labs(
      x = "Year",
      y = "Normalized Viability"
    )

allModelFrame %>%
  filter(variable == "NORMALIZED_ELECTABILITY",
         modelname %in% c("df08phone_d_reg", "df04_national_d_reg",
                          "df00_national_d_reg", "df84cm_d_reg")) %>%
  ggplot(aes(color = modelname)) +
    geom_hline(yintercept = 0, colour = gray(1 / 2), lty = 2) +
    geom_pointrange(aes(x = variable, y = coef, 
                        ymin = coef - se * interval2,
                        ymax = coef + se * interval2),
                    lwd = 1 / 2, position = position_dodge(width = 1 / 2),
                    shape = 21, fill = "WHITE") +
    geom_linerange(aes(x = variable, ymin = coef - se*interval1,
                       ymax = coef + se * interval1),
                   lwd = 1, position = position_dodge(width = 1 / 2)) +
    scale_y_continuous(trans = log2_trans(), 
                       breaks = trans_breaks("log2", function(x) 2^x),
                       limits = c(-10, 10)) +
    theme_bw() +
    labs(
      x = "Year",
      y = "Normalized Electability"
    )

allModelFrame %>%
  filter(variable == "NORMALIZED_FT",
         modelname %in% c("df08phone_d_reg", "df04_national_d_reg",
                          "df00_national_d_reg", "df84cm_d_reg")) %>%
  ggplot(aes(color = modelname)) +
    geom_hline(yintercept = 0, colour = gray(1 / 2), lty = 2) +
    geom_pointrange(aes(x = variable, y = coef, 
                        ymin = coef - se * interval2,
                        ymax = coef + se * interval2),
                    lwd = 1 / 2, position = position_dodge(width = 1 / 2),
                    shape = 21, fill = "WHITE") +
    geom_linerange(aes(x = variable, ymin = coef - se*interval1,
                       ymax = coef + se * interval1),
                   lwd = 1, position = position_dodge(width = 1 / 2)) +
    scale_y_continuous(trans = log2_trans(), 
                       breaks = trans_breaks("log2", function(x) 2^x),
                       limits = c(-10, 10)) +
    theme_bw() +
    labs(
      x = "Year",
      y = "Normalized Favorability"
    )

allModelFrame %>%
  filter(variable == "NORMALIZED_FT",
         modelname %in% c("df08phone_d_reg", "df04_national_d_reg",
                          "df00_national_d_reg", "df84cm_d_reg")) %>%
  ggplot(aes(color = modelname)) +
    geom_hline(yintercept = 0, colour = gray(1 / 2), lty = 2) +
    geom_pointrange(aes(x = variable, y = coef, 
                        ymin = coef - se * interval2,
                        ymax = coef + se * interval2),
                    lwd = 1 / 2, position = position_dodge(width = 1 / 2),
                    shape = 21, fill = "WHITE") +
    geom_linerange(aes(x = variable, ymin = coef - se*interval1,
                       ymax = coef + se * interval1),
                   lwd = 1, position = position_dodge(width = 1 / 2)) +
    scale_y_continuous(trans = log2_trans(), 
                       breaks = trans_breaks("log2", function(x) 2^x),
                       limits = c(-10, 10)) +
    theme_bw() +
    labs(
      x = "Year",
      y = "Normalized Ideology"
    )

```
























## Miscellaneous

```{r}

mlogit(data = df00_national_d, formula = VoteCandidate ~ NORMALIZED_FT + NORMALIZED_VIABILITY + NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY, reflevel = "GORE")

model1 <- clogit(data = df00_national_d, formula = VoteCandidate ~ BRADLEY +
                      NORMALIZED_FT + NORMALIZED_VIABILITY + 
                      NORMALIZED_ELECTABILITY + NORMALIZED_IDEOLOGY + 
                      strata(Candidate))


effects(df00_national_d_reg, covariate = "NORMALIZED_FT", data = df00_national_d)

df08phone_d_reg %>%
  ggplot(aes(x = coefficients)) +
    geom_histogram()

effect_plot(df08phone_d_reg, pred = NORMALIZED_FT, interval = TRUE, plot.points = TRUE)
plot_summs(df08phone_d_reg)
plot_model(df08phone_d_reg)


```

